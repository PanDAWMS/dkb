
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pyDKB.dataflow.stage.ProcessorStage &#8212; Data Knowledge Base  documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyDKB.dataflow.stage.ProcessorStage</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Definition of an abstract class for Dataflow Data Processing Stages.</span>

<span class="sd">        USAGE:</span>
<span class="sd">         ProcessorStage [&lt;options&gt;] [&lt;input files&gt;]</span>

<span class="sd">        OPTIONS:</span>
<span class="sd">         -s, --source       {f|s|h}     - where to get data from:</span>
<span class="sd">                                          local (f)iles, (s)tdin, (h)dfs</span>
<span class="sd">         -i, --input-dir    DIR         - base directory for relative input</span>
<span class="sd">                                          file names (for local and HDFS</span>
<span class="sd">                                          sources).</span>
<span class="sd">                                          If &lt;input files&gt; not specified,</span>
<span class="sd">                                          all files from the directory will</span>
<span class="sd">                                          be taken as the input.</span>

<span class="sd">         -d, --dest         {f|s|h}     - where to send data to:</span>
<span class="sd">                                          local (f)iles, (s)tdout, (h)dfs</span>

<span class="sd">         -o, --output-dir   DIR         - base directory for output files</span>
<span class="sd">                                          (for local and HDFS sources)</span>

<span class="sd">         --hdfs                         - equivalent to &quot;--source h --dest h&quot;</span>

<span class="sd">         -m, --mode         MODE        - MODE:</span>
<span class="sd">                                          (f)ile      = --source f</span>
<span class="sd">                                                        --dest f (can be</span>
<span class="sd">                                                           rewritten with &#39;s&#39;</span>
<span class="sd">                                                                       or &#39;h&#39;)</span>

<span class="sd">                                          (s)tream    = --source s (can be</span>
<span class="sd">                                                           rewritten with &#39;h&#39;)</span>
<span class="sd">                                                        --dest s</span>

<span class="sd">                                          (m)apreduce = --source s (can be</span>
<span class="sd">                                                           rewritten with &#39;h&#39;)</span>
<span class="sd">                                                        --dest s</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">AbstractStage</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">messageType</span>
<span class="kn">from</span> <span class="nn">pyDKB.common.types</span> <span class="k">import</span> <span class="n">logLevel</span>
<span class="kn">from</span> <span class="nn">pyDKB.dataflow</span> <span class="k">import</span> <span class="n">DataflowException</span>
<span class="kn">from</span> <span class="nn">pyDKB.common</span> <span class="k">import</span> <span class="n">hdfs</span>
<span class="kn">from</span> <span class="nn">pyDKB.dataflow</span> <span class="k">import</span> <span class="n">communication</span>
<span class="kn">from</span> <span class="nn">pyDKB.dataflow.communication</span> <span class="k">import</span> <span class="n">consumer</span>
<span class="kn">from</span> <span class="nn">pyDKB.dataflow.communication</span> <span class="k">import</span> <span class="n">producer</span>


<div class="viewcode-block" id="ProcessorStage"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage">[docs]</a><span class="k">class</span> <span class="nc">ProcessorStage</span><span class="p">(</span><span class="n">AbstractStage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Abstract class to implement Processor stages</span>

<span class="sd">    Processor stage -- is a stage for data processing/transformation.</span>

<span class="sd">    Class/instance variable description:</span>

<span class="sd">    * communication.consumer.Consumer instance</span>
<span class="sd">        __input</span>

<span class="sd">    * Generator object for output file descriptor</span>
<span class="sd">      OR file descriptor (for (s)tream mode)</span>
<span class="sd">        __output</span>

<span class="sd">    * List of objects to be &quot;stopped&quot;</span>
<span class="sd">        __stoppable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__input_message_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__output_message_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">__input</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_out_stream</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Name of the option that switches stage into &#39;skip&#39; mode</span>
    <span class="n">_skip_option</span> <span class="o">=</span> <span class="s1">&#39;--skip&#39;</span>

    <span class="c1"># Arguments to be reset to original default values if stage is to be</span>
    <span class="c1"># skipped</span>
    <span class="c1"># NOTE: values specified explicitly (in command line) won&#39;t be reset</span>
    <span class="n">_reset_on_skip</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;DKB Dataflow data processing stage.&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize the stage</span>

<span class="sd">        * set description</span>
<span class="sd">        * define common Processor arguments:</span>
<span class="sd">            input, --hdfs, --hdfs-dir, --output, ...</span>
<span class="sd">        * ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stoppable</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProcessorStage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

<div class="viewcode-block" id="ProcessorStage.set_input_message_type"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.set_input_message_type">[docs]</a>    <span class="k">def</span> <span class="nf">set_input_message_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set input message type. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">messageType</span><span class="o">.</span><span class="n">hasMember</span><span class="p">(</span><span class="n">Type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown message type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__input_message_type</span> <span class="o">=</span> <span class="n">Type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__input</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__input</span><span class="o">.</span><span class="n">set_message_type</span><span class="p">(</span><span class="n">Type</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessorStage.input_message_class"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.input_message_class">[docs]</a>    <span class="k">def</span> <span class="nf">input_message_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get input message class. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">communication</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__input_message_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessorStage.set_output_message_type"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.set_output_message_type">[docs]</a>    <span class="k">def</span> <span class="nf">set_output_message_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set output message class. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">messageType</span><span class="o">.</span><span class="n">hasMember</span><span class="p">(</span><span class="n">Type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown message type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__output_message_type</span> <span class="o">=</span> <span class="n">Type</span></div>

<div class="viewcode-block" id="ProcessorStage.output_message_class"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.output_message_class">[docs]</a>    <span class="k">def</span> <span class="nf">output_message_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get output message class. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">communication</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__output_message_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessorStage.defaultArguments"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.defaultArguments">[docs]</a>    <span class="k">def</span> <span class="nf">defaultArguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Default parser configuration. &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProcessorStage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">defaultArguments</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;input_files&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;source data file</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;NOTE: required in (f)ile, &#39;</span>
                          <span class="s1">&#39;ignored in other modes&#39;</span><span class="p">,</span>
                          <span class="n">metavar</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;FILE&#39;</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--source&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;where to get data from:</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;    f -- local files</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;    s -- stdin</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;    h -- hdfs files</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;DEFAULT: </span><span class="se">\&#39;</span><span class="s1">f</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">],</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;source&#39;</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--input-dir&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;directory with input files (local or HDFS), &#39;</span>
                          <span class="s1">&#39;or initial directory for relative FILE names. &#39;</span>
                          <span class="s1">&#39;If no FILE is specified, all files with &#39;</span>
                          <span class="s1">&#39;extension matching input message type will &#39;</span>
                          <span class="s1">&#39;be taken from </span><span class="si">%%</span><span class="s1">(metavar)s</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;DEFAULT: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;DIR&#39;</span><span class="p">,</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;input_dir&#39;</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--dest&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;where to write results:</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;    f -- local files</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;    s -- stdout</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;    h -- hdfs files</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;DEFAULT: </span><span class="se">\&#39;</span><span class="s1">f</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">],</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;dest&#39;</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output-dir&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;directory for output files &#39;</span>
                          <span class="s1">&#39;(local or HDFS). </span><span class="si">%%</span><span class="s1">(metavar)s can be:</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; * absolute path</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; * relative path (for local files)</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; * subpath (not absolute nor relative).</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;In case of subpath (or relative path for &#39;</span>
                          <span class="s1">&#39;HDFS output) </span><span class="si">%%</span><span class="s1">(metavar)s is taken &#39;</span>
                          <span class="s1">&#39;as relative to the one of:</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; * directory with input files</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; * current directory (for local files)</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; * </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s1">temp</span><span class="se">\&#39;</span><span class="s1"> (for HDFS)&#39;</span> <span class="o">%</span> <span class="n">hdfs</span><span class="o">.</span><span class="n">DKB_HOME</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span>
                          <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;DIR&#39;</span><span class="p">,</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;output_dir&#39;</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--hdfs&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;equivalent to &quot;--source h --dest h&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;Explicit specification of &#39;</span>
                          <span class="s1">&#39;&quot;--source&quot; and &quot;--dest&quot; as well as the default &#39;</span>
                          <span class="s1">&#39;values for current processing mode (&quot;--mode&quot;) will &#39;</span>
                          <span class="s1">&#39;be ignored&#39;</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;hdfs&#39;</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_skip_option</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;Skip process and push input message &#39;</span>
                          <span class="s1">&#39;forward as-is (marking it as &quot;incomplete&quot;).&#39;</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;skip_process&#39;</span>
                          <span class="p">)</span></div>

<div class="viewcode-block" id="ProcessorStage.set_default_arguments"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.set_default_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_on_skip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set (or overwrite) default values for arguments.</span>

<span class="sd">        :param ignore_on_skip: ignore new default value when the stage</span>
<span class="sd">                               is to be skipped</span>
<span class="sd">        :type ignore_on_skip: bool</span>

<span class="sd">        :param &lt;arg_name&gt;: default value for argument &lt;arg_name&gt;</span>
<span class="sd">        :type &lt;arg_name&gt;: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProcessorStage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_default_arguments</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ignore_on_skip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_on_skip</span> <span class="o">+=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProcessorStage.configure"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Configure stage according to the config parameters.</span>

<span class="sd">        If $args specified, arguments will be parsed anew.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skip_option</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_default_arguments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reset_on_skip</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ARGS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Need to initialize ARGS to proceed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__input</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="n">ConsumerBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARGS</span><span class="p">))</span> \
                <span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__input_message_type</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">build</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__stoppable_append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__input</span><span class="p">,</span> <span class="n">consumer</span><span class="o">.</span><span class="n">Consumer</span><span class="p">)</span>
            <span class="c1"># Output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__output</span> <span class="o">=</span> <span class="n">producer</span><span class="o">.</span><span class="n">ProducerBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARGS</span><span class="p">))</span> \
                <span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__output_message_type</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">setSourceInfoMethod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_source_info</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">build</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__stoppable_append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__output</span><span class="p">,</span> <span class="n">producer</span><span class="o">.</span><span class="n">Producer</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">consumer</span><span class="o">.</span><span class="n">ConsumerException</span><span class="p">,</span> <span class="n">producer</span><span class="o">.</span><span class="n">ProducerException</span><span class="p">),</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="n">logLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_configuration</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProcessorStage.get_source_info"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.get_source_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_source_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get information about current source. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__input</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__input</span><span class="o">.</span><span class="n">get_source_info</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="ProcessorStage.run"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run process() for every input() message. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ARGS</span><span class="o">.</span><span class="n">skip_process</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_process</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Starting stage execution (skip mode).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Starting stage execution.&quot;</span><span class="p">)</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flush_buffer</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clear_buffer</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># Catch everything for uniform exception handling</span>
            <span class="c1"># Clear buffer -- just in case someone will decide</span>
            <span class="c1"># to reuse the object.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
                <span class="n">exit_code</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">code</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_error</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear_buffer</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">DataflowException</span><span class="p">:</span>
                <span class="c1"># In case the previous error is related to the output</span>
                <span class="c1"># stream, we should skip this error here to exit the</span>
                <span class="c1"># program properly</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># NOTE: If something went wrong in `except` clause, we will still</span>
            <span class="c1"># get here and return, so the exceptions from there will never</span>
            <span class="c1"># reach the user</span>
            <span class="k">if</span> <span class="n">err</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">exit_code</span></div>

    <span class="c1"># Override</span>
<div class="viewcode-block" id="ProcessorStage.stop"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Finalize all the processes and prepare to exit. &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProcessorStage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stoppable</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Close method is not defined for </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">p</span><span class="p">,</span>
                         <span class="n">logLevel</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">failures</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">failures</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Failed to stop </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                         <span class="n">logLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_error</span><span class="p">(</span><span class="n">exc_info</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="ProcessorStage.process"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.process">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">input_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Transform input_message -&gt; output_message.</span>

<span class="sd">        To be implemented individually for every stage.</span>
<span class="sd">        Takes the stage as first argument to allow calling output()</span>
<span class="sd">          from inside the function.</span>

<span class="sd">        Return value:</span>
<span class="sd">            True  -- processing successfully finished</span>
<span class="sd">            False -- processing failed (skip the input message)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Stage method process() is not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessorStage.skip_process"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.skip_process">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">skip_process</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">input_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Process input_message in &quot;skip&quot; processing mode.</span>

<span class="sd">        Skip mode is turned on with command line parameter `--skip`; in this</span>
<span class="sd">        mode stage is expected to skip its &quot;semantic&quot; part of the message</span>
<span class="sd">        transformation (like changes in data fields format, definition of</span>
<span class="sd">        additional data fields, etc) but perform actions required to keep</span>
<span class="sd">        the dataflow seamless.</span>

<span class="sd">        The simpliest way to achieve this is to send the input message to the</span>
<span class="sd">        output without changes (marking it as &quot;incomplete&quot;), and this is</span>
<span class="sd">        the default implementation of the method.</span>

<span class="sd">        In some cases it may be necessary to re-implement it (just like</span>
<span class="sd">        `process()`) to keep the dataflow unbroken.</span>

<span class="sd">        NOTE: the output messages in &quot;skip&quot; mode MUST be marked as</span>
<span class="sd">              &quot;incomplete&quot;.</span>

<span class="sd">        :param input_message: message to process</span>
<span class="sd">        :type input_message: pyDKB.messages.AbstractMessage</span>

<span class="sd">        :return: True/False (success/failure)</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_msg</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">output_message_class</span><span class="p">()(</span><span class="n">input_message</span><span class="o">.</span><span class="n">content</span><span class="p">())</span>
        <span class="n">out_msg</span><span class="o">.</span><span class="n">incomplete</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">out_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ProcessorStage.input"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.input">[docs]</a>    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generator for input messages.</span>

<span class="sd">        Returns iterable object.</span>
<span class="sd">        Every iteration returns single input message to be processed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__input</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">r</span></div>

<div class="viewcode-block" id="ProcessorStage.output"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Put the (list of) message(s) to the output buffer. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessorStage.forward"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send EOPMarker to the output stream. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__output</span><span class="o">.</span><span class="n">eop</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProcessorStage.flush_buffer"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.flush_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">flush_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Flush message buffer to the output. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__output</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProcessorStage.clear_buffer"><a class="viewcode-back" href="../../../../pyDKB/pyDKB.dataflow.stage.ProcessorStage.html#pyDKB.dataflow.stage.ProcessorStage.clear_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">clear_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Drop buffered output messages. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__output</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__stoppable_append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Appends OBJ (of type CLS) to the list of STOPPABLE. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__stoppable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">Data Knowledge Base</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyDKB/pyDKB.html">pyDKB package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Stages/Stages.html">Stages</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, DKB team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>
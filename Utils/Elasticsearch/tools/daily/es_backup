#!/bin/sh

base_dir=/var/es
data_dir=data
backup_dir="$base_dir"/backup


[ -d "$backup_dir" ] \
  || mkdir -p -m 0700 "$backup_dir" \
  || exit 1

backup_name="$backup_dir/$data_dir"

# Rotate backup files
logrotate "$0".logrotate

# Check that backup file does not exist
[ -f "${backup_name}.tar.gz" ] \
  && { echo "Backup for ES data already exists:" \
            "manually remove it to create a new one" \
            "(${backup_name}.tar.gz)." >&2 ;
       exit 0;
     }

# Create backup file
tar -C "$base_dir" -zcf "${backup_name}.tar.gz" "$data_dir"
EXIT_CODE=$?

[ "$EXIT_CODE" -ne 0 ] \
  && { echo "Failed to create backup file for ES data ($EXIT_CODE)." >&2 ;
       exit "$EXIT_CODE";
     }

exit 0

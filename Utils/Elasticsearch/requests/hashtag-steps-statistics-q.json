/* Get statistics for tasks with given hashtag by steps.

Parameter values:
  HASHTAG_LOWERCESE -- hashtag ("gammajets")

GET <index>/task/_search
*/
{
  "size": 0,
  "query": {
    "bool": {
      "must": [
        {"term": {"hashtag_list": %%HASHTAG_LOWERCASE%%}},
        {"term": {"status": "done"}},
        {"term": {"primary_input_deleted": false}}
      ]
    }
  },
  "aggs": {
    "steps": {
      "terms": {"field": "step_name.keyword"},
      "aggs": {
        "input_events": {
          "sum": {"field": "requested_events"}
        },
        "input_bytes": {
          "sum": {"field": "input_bytes"}
        },
        "output": {
          "children": {"type": "output_dataset"},
          "aggs": {
            "not_removed": {
              "filter": {"term": {"deleted": false}},
              "aggs": {
                "bytes": {
                  "sum": {"field": "bytes"}
                },
                "events": {
                  "sum": {"field": "events"}
                }
              }
            }
          }
        }
      }
    }
  }
}
